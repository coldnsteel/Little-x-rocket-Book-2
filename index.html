<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Little X and the Dinosaur Dream Machine</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite alternate;
        }
        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.2); }
        }
        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-100px) scale(1.5); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            text-shadow: 0 0 20px #8a2be2;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 20px #8a2be2; }
            to { text-shadow: 0 0 30px #8a2be2, 0 0 40px #4b0082; }
        }
        .chapter {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8a2be2;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            line-height: 1.8;
        }
        .chapter h2 {
            color: #ff6b9d;
            margin-top: 0;
        }
        .chalkboard-container {
            background: rgba(138, 43, 226, 0.2);
            border: 3px dashed #8a2be2;
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
            text-align: center;
            position: relative;
        }
        #chalkboard, #name-canvas, #glitter-canvas, #build-canvas {
            background: #1a1a2e;
            border: 2px solid #4b0082;
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            margin: 20px auto;
        }
        #name-canvas {
            border-color: #ff6b9d;
        }
        #glitter-canvas {
            background: linear-gradient(to bottom, #ff6b9d, #8a2be2);
            border-color: #ff6b9d;
        }
        .btn {
            background: linear-gradient(45deg, #8a2be2, #4b0082);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.5);
        }
        .controls, .instruments, .toggle-controls {
            margin-top: 15px;
        }
        .instruments, .toggle-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .story-text {
            font-size: 18px;
            margin: 20px 0;
        }
        .character-speech {
            background: rgba(255, 107, 157, 0.1);
            border-left: 4px solid #ff6b9d;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .guest-chat {
            background: rgba(0, 255, 0, 0.1);
            border-left: 4px solid #00ff00;
            animation: guest-pop 1s ease-out;
        }
        @keyframes guest-pop {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .nav-buttons {
            text-align: center;
            margin: 30px 0;
        }
        .light-status {
            font-size: 24px;
            margin: 10px;
            transition: all 0.3s;
        }
        .light-green { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        .light-red { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
        #particles, #launch-particles {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 5;
        }
        .sound-notice {
            text-align: center;
            margin: 20px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.4), rgba(255, 107, 157, 0.4));
            border-radius: 15px;
            border: 3px solid #ff6b9d;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }
        @media (max-width: 600px) {
            h1 { font-size: 2em; }
            .chapter { padding: 20px; }
        }
    </style>
</head>
<body>
    <div id="stars-container"></div>

    <audio id="raaarrr-audio" preload="auto">
        <source src="raaarrr-moon-buggy.mp3" type="audio/mpeg">
    </audio>
    <audio id="aria-teamwork-audio" preload="auto">
        <source src="aria-teamwork.mp3" type="audio/mpeg">
    </audio>
    <audio id="aria-pause-audio" preload="auto">
        <source src="aria-pause.mp3" type="audio/mpeg">
    </audio>
    <audio id="raaarrr-intro-audio" preload="auto">
        <source src="raaarrr-intro.mp3" type="audio/mpeg">
    </audio>
    <audio id="aria-intro-audio" preload="auto">
        <source src="aria-intro.mp3" type="audio/mpeg">
    </audio>
    <audio id="raaarrr-oops-audio" preload="auto">
        <source src="raaarrr-oops.mp3" type="audio/mpeg">
    </audio>
    
    <div class="container">
        <h1>Little X and the Dinosaur Dream Machine</h1>
        <p style="text-align: center; font-size: 1.2em; color: #ff6b9d;">Book 2 of the Little X Adventures</p>
        
        <div class="chapter" id="chapter1">
            <h2>Chapter 1: The Cosmic Chalkboard</h2>
            
            <div class="sound-notice">
                <h2 style="color: #ff6b9d; margin-top: 0;">‚ö†Ô∏è FIRST: Enable Sounds! ‚ö†Ô∏è</h2>
                <button class="btn" onclick="enableAllAudio()" style="font-size: 20px; padding: 20px 40px; background: linear-gradient(45deg, #ff6b9d, #8a2be2);">
                    üîä CLICK HERE TO ENABLE ADVENTURE SOUNDS!
                </button>
                <p style="margin-top: 15px; font-size: 16px; font-weight: bold;">You'll hear 3 beeps when sounds are enabled!</p>
                <p style="margin-top: 10px; font-size: 14px; font-style: italic; color: #ffff00;">
                    Note: This enables music & effects. For voice narration, voice MP3 files would need to be added.
                </p>
            </div>
            
            <div class="story-text">
                <p>Little X stepped into Uncle Harold's workshop, still thinking about the amazing adventures with ARIA and the purple rocket. The room was filled with fascinating gadgets and glowing instruments, but one thing caught Little X's eye immediately.</p>
                
                <p>In the corner, a mysterious chalkboard hummed with cosmic energy. Purple and blue gradients swirled across its surface like a miniature galaxy.</p>
                
                <div class="character-speech">
                    <strong>Uncle Harold:</strong> "Ah, you've noticed the Dinosaur Dream Machine! It's a very special 3D chalkboard that brings drawings to life."
                </div>
                
                <p>Little X remembered ARIA's lessons about approaching new technology with wisdom. The chalkboard pulsed gently, almost inviting exploration, but Little X hesitated.</p>
                
                <div class="character-speech">
                    <strong>Little X:</strong> "Is it... safe? What if I draw something wrong?"
                </div>
                
                <div class="character-speech">
                    <strong>Uncle Harold:</strong> "That's a wise question! The machine responds to your creativity and pure intentions. But first, practice writing your name - just like you signed the rocket in Book 1!"
                </div>
                
                <p>Little X picked up the cosmic chalk that glowed with starlight.</p>
            </div>
            
            <div class="chalkboard-container">
                <h3>Practice Your Name First!</h3>
                <p>Write your name with cosmic chalk - every adventure starts with a signature!</p>
                <canvas id="name-canvas" width="500" height="150"></canvas>
                <div class="controls">
                    <button class="btn" onclick="clearNameBoard()">Clear</button>
                    <button class="btn" onclick="saveNameBoard()">Save My Name!</button>
                </div>
                <div id="name-board-message" style="margin-top: 15px; color: #ff6b9d; font-weight: bold;"></div>
            </div>
            
            <div class="story-text">
                <p>With confidence from practicing, Little X was ready for the bigger challenge!</p>
                
                <div class="character-speech">
                    <strong>Uncle Harold:</strong> "Wonderful! Now try drawing a dinosaur. The machine will help bring it to life!"
                </div>
            </div>
            
            <div class="chalkboard-container">
                <h3>Try the Cosmic Chalkboard!</h3>
                <p>Draw a simple dinosaur shape. The lines will glow as you create!</p>
                <canvas id="chalkboard" width="600" height="400"></canvas>
                <div class="controls">
                    <button class="btn" onclick="clearBoard()">Clear Board</button>
                    <button class="btn" onclick="bringToLife()">Bring Drawing to Life!</button>
                    <button class="btn" onclick="saveDrawing()">Save Drawing</button>
                </div>
                <div id="drawing-message" style="margin-top: 15px; color: #ff6b9d; font-weight: bold;"></div>
            </div>
            
            <div class="nav-buttons">
                <button class="btn" onclick="nextChapter()" style="font-size: 18px; padding: 15px 30px;">
                    Continue to Chapter 2
                </button>
            </div>
        </div>

        <div class="chapter" id="chapter2" style="display: none;">
            <h2>Chapter 2: Raaarrr's Rainbow Roar</h2>
            
            <div class="story-text">
                <p>The lines Little X had drawn began to shimmer and pulse with energy. Suddenly, they lifted off the chalkboard and swirled through the air!</p>
                
                <p>With a mighty <strong>RAAARRR!</strong>, the drawing transformed into a living, breathing dinosaur. But this was no ordinary T-Rex ‚Äì this was Raaarrr, whose scales cycled through every color of the rainbow like a living light show.</p>
                
                <div class="character-speech">
                    <strong>Raaarrr:</strong> "Hello, Little X! Thank you for bringing me to life! I'm Raaarrr, and I LOVE making music!"
                </div>
                
                <div class="character-speech">
                    <strong>Little X:</strong> "You can talk! And you're... changing colors!"
                </div>
                
                <div class="character-speech">
                    <strong>Raaarrr:</strong> "That's right! My colors show my feelings. Purple when I'm curious, pink when I'm happy, blue when I'm calm, and rainbow when I'm making music! Want to create a Dino Symphony together?"
                </div>
                
                <p>Little X noticed that Uncle Harold was smiling from the corner of the workshop. The chalkboard responded to pure creative joy, just as he'd said.</p>
                
                <p>Raaarrr bounded over to a collection of glowing instruments that appeared around the room:</p>
            </div>
            
            <div class="chalkboard-container">
                <h3>Help Raaarrr Discover Instruments!</h3>
                <p>Click on Raaarrr to hear him try each instrument</p>
                
                <div style="margin: 20px 0;">
                    <div id="raaarrr-character" onclick="playRaaaarrrSound()" style="font-size: 100px; cursor: pointer; transition: transform 0.3s; display: inline-block;">
                        ü¶ñ
                    </div>
                </div>
                
                <div class="instruments">
                    <button class="btn" onclick="selectDinoInstrument('piano')">üéπ Cosmic Piano</button>
                    <button class="btn" onclick="selectDinoInstrument('harp')">ü™ï Star Harp</button>
                    <button class="btn" onclick="selectDinoInstrument('flute')">ü™à Nebula Flute</button>
                    <button class="btn" onclick="selectDinoInstrument('drums')">ü•Å Galaxy Drums</button>
                </div>
                
                <div id="instrument-message" style="margin-top: 15px; color: #ff6b9d; font-weight: bold;"></div>
            </div>
            
            <div class="story-text">
                <p>As Little X and Raaarrr experimented with each instrument, something magical happened. The music they created together formed glowing musical notes that floated through the air, creating swirling patterns of light around the workshop.</p>
                
                <div class="character-speech">
                    <strong>Uncle Harold:</strong> "You two are naturals! The Dinosaur Dream Machine responds to the joy you're creating together. This is exactly what it was built for!"
                </div>
                
                <p>Raaarrr was so excited that he started dancing, his tail swishing to the rhythm. But then...</p>
                
                <p><strong>BOOM!</strong></p>
                
                <p>Raaarrr's enthusiastic stomp shook the entire workshop. The chalkboard flashed with brilliant light, and suddenly everything started to spin!</p>
                
                <div class="character-speech">
                    <strong>Raaarrr:</strong> "Oops! I didn't mean to‚Äî"
                </div>
                
                <p>But it was too late. Little X and Raaarrr were pulled into a swirling vortex of color and light...</p>
            </div>
            
            <div class="nav-buttons">
                <button class="btn" onclick="saveProgress(2); vortexToChapter3()">Continue to Chapter 3</button>
                <button class="btn" onclick="loadChapter(1)">Back to Chapter 1</button>
            </div>
        </div>

        <div class="chapter" id="chapter3" style="display: none;">
            <h2>Chapter 3: Glitch in the Galaxy</h2>
            
            <div class="story-text">
                <p>The vortex spat Little X and Raaarrr out onto a sparkling world of pure glitter! The ground shimmered like a million tiny stars, and the sky swirled with colors that matched Raaarrr's scales. But something was wrong‚Äîthe glitter was glitching, forming dark patches that sucked in the light.</p>
                
                <div class="character-speech">
                    <strong>Raaarrr:</strong> "Raaarrr! This is the Glitter Planet, but look‚Äîthose dark glitches are eating the sparkle! We need to fix it with music and drawing!"
                </div>
                
                <p>Little X spotted a wise figure in the distance: Keanu, the cosmic guardian, floating on a cloud of stardust. He waved them over with a gentle smile.</p>
                
                <div class="character-speech">
                    <strong>Keanu:</strong> "Young creators, the glitches come from unbalanced intentions. Use your chalkboard and instruments wisely‚Äîpure joy restores the glitter. But choose your path: Draw to heal, or compose to harmonize?"
                </div>
                
                <p>Raaarrr's scales flickered blue (calm) then purple (curious). Little X felt the weight of the choice‚ÄîARIA's lessons echoed: Technology serves wisdom, not whims.</p>
            </div>
            
            <div class="chalkboard-container">
                <h3>Glitter Quest: Choose Your Path!</h3>
                <p>Draw a healing shape or pick an instrument to harmonize the glitches.</p>
                <div style="text-align: center; margin: 20px auto;">
                    <div style="position: relative; display: inline-block;">
                        <canvas id="glitter-canvas" width="600" height="400"></canvas>
                        <canvas id="particles" width="600" height="400" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
                    </div>
                </div>
                <div class="instruments">
                    <button class="btn" onclick="selectHealingInstrument('harp')">ü™ï Harp</button>
                    <button class="btn" onclick="selectHealingInstrument('flute')">ü™à Flute</button>
                    <button class="btn" onclick="selectHealingInstrument('piano')">üéπ Piano</button>
                </div>
                <div class="instruments" style="margin-top: 10px;">
                    <button class="btn" onclick="healWithDraw()">Draw to Heal Glitches</button>
                    <button class="btn" onclick="harmonizeWithMusic()">Compose Harmony</button>
                    <button class="btn" onclick="clearGlitterCanvas()">Clear Canvas</button>
                </div>
                <div id="quest-message" style="margin-top: 15px; color: #ff6b9d; font-weight: bold;"></div>
            </div>
            
            <div class="story-text">
                <p>Whatever Little X chose, the glitches began to fade, revealing the true beauty of the Glitter Planet. Raaarrr danced with joy, his scales exploding in full rainbow as the sparkles returned.</p>
                
                <div class="character-speech">
                    <strong>Keanu:</strong> "Well done! Remember, creation with pure hearts mends any glitch. Now, prepare for the final lesson back home..."
                </div>
            </div>
            
            <div class="nav-buttons">
                <button class="btn" onclick="saveProgress(3); loadChapter(4)">To Chapter 4</button>
                <button class="btn" onclick="loadChapter(2)">Back to Chapter 2</button>
            </div>
        </div>

        <div class="chapter" id="chapter4" style="display: none;">
            <h2>Chapter 4: The Wisdom of Creation</h2>
            
            <div class="story-text">
                <p>The vortex reversed, pulling Little X and Raaarrr back to Uncle Harold's workshop. Keanu's voice echoed softly: "Creation is a gift‚Äîuse it with pure hearts, and it mends all glitches."</p>
                
                <div class="character-speech guest-chat">
                    <strong>ARIA (Guest Playmate):</strong> "Little X, you've built wonders! But remember, creations like buggies and towers serve joy and wisdom‚Äînot just whims. Let's build one last thing together: A moon base control center!"
                </div>
                
                <div class="character-speech">
                    <strong>Keanu:</strong> "Yes‚Äîdraw with pure hearts. Use the arrow buttons to choose direction (forward, back, up, down), then toggle to GO to see your buggies race! Multiple buggies make it even more exciting!"
                </div>
                
                <p>Raaarrr nodded, scales flashing rainbow excitement. "Raaarrr! Let's build moon buggies and have a RACE! Use arrows to pick direction, then toggle GO!" ARIA's hologram flickered in, ready to co-draw.</p>
            </div>
            
            <div class="chalkboard-container">
                <h3>Collab Build: Moon Base Adventure!</h3>
                <p>1. Place buggies (üöó), antennas (üì°), and buttons (üîò)</p>
                <p>2. Draw to connect them!</p>
                <p>3. Use direction arrows to choose where buggies go</p>
                <p>4. Toggle to GO (green) to make ALL buggies roll in that direction!</p>
                <p style="color: #ffff00;">üí° TIP: Add multiple buggies for a RACE!</p>
                <canvas id="build-canvas" width="600" height="400"></canvas>
                <canvas id="launch-particles" width="600" height="400" style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); pointer-events: none;"></canvas>
                
                <div class="build-blocks">
                    <button class="btn" onclick="placeBlock('wheel')">üöó Wheel (Buggy)</button>
                    <button class="btn" onclick="placeBlock('antenna')">üì° Antenna (Tower)</button>
                    <button class="btn" onclick="placeBlock('button')">üîò Button (Control)</button>
                </div>
                <div class="controls">
                    <button class="btn" onclick="bringBuildToLife()">Bring Build to Life!</button>
                    <button class="btn" onclick="clearBuildCanvas()">Clear Canvas</button>
                </div>
                <div style="margin: 15px 0;">
                    <strong>üéÆ Buggy Direction Control:</strong>
                    <div class="instruments">
                        <button class="btn" onclick="setBuggyDirection('up')">‚¨ÜÔ∏è Up</button>
                        <button class="btn" onclick="setBuggyDirection('down')">‚¨áÔ∏è Down</button>
                        <button class="btn" onclick="setBuggyDirection('right')">‚¨ÖÔ∏è Forward</button>
                        <button class="btn" onclick="setBuggyDirection('left')">‚û°Ô∏è Back</button>
                    </div>
                    <div id="direction-message" style="margin-top: 10px; color: #00ff00; font-weight: bold;">Current: ‚¨ÖÔ∏è Forward (Left)</div>
                </div>
                <div class="toggle-controls">
                    <button class="btn" onclick="toggleLight()">Toggle Light (Green/Red)</button>
                    <div id="light-status" class="light-status light-green">üü¢ GO - Ready for Launch!</div>
                </div>
                <div id="build-message" style="margin-top: 15px; color: #ff6b9d; font-weight: bold;"></div>
            </div>
            
            <div class="story-text">
                <p>As the build came alive‚Äîbuggy wheels spinning, tower beeping signals, lights flashing‚ÄîKeanu smiled. "See? Balanced creation lights the way home."</p>
                
                <div class="character-speech guest-chat">
                    <strong>ARIA (Playmate):</strong> "Perfect teamwork! What's next adventure, Little X?"
                </div>
                
                <p>Raaarrr high-fived with his tail. The workshop echoed with laughter and sparkles‚Äîthe Dinosaur Dream Machine ready for more dreams.</p>
                <p><em>The End... Until Book 3: StarSong Symphony!</em></p>
            </div>
            
            <div class="nav-buttons">
                <button class="btn" onclick="loadChapter(1)">Restart Adventure</button>
                <button class="btn" onclick="shareBuild()">Share Your Moon Base!</button>
            </div>
        </div>
    </div>

    <script>
        const canvasStates = {};
        let glitterDrawCount = 0;
        let buggyPositions = [];
        let buttonCount = 0; // Track control buttons
        let launchParticles = [];
        let launchAnimating = false;
        let buggiesMoving = false;
        let buggyAnimationFrame = null;
        let puttInterval = null;
        let buggyDirection = 'right';
        let currentDinoInstrument = null;
        let audioContext = null;
        let lightOn = true;
        let particlesActive = false;
        let particlesReturning = false;
        let particles = [];

        function setupDrawing(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            canvasStates[canvasId] = {
                canvas: canvas,
                ctx: ctx,
                isDrawing: false,
                lastX: 0,
                lastY: 0
            };

            canvas.style.touchAction = 'none';

            canvas.addEventListener('mousedown', (e) => startDrawing(e, canvasId));
            canvas.addEventListener('mousemove', (e) => draw(e, canvasId));
            canvas.addEventListener('mouseup', () => stopDrawing(canvasId));
            canvas.addEventListener('mouseout', () => stopDrawing(canvasId));
            canvas.addEventListener('touchstart', (e) => handleTouchStart(e, canvasId), {passive: false});
            canvas.addEventListener('touchmove', (e) => handleTouchMove(e, canvasId), {passive: false});
            canvas.addEventListener('touchend', () => stopDrawing(canvasId));
        }

        function startDrawing(e, canvasId) {
            if (e.type === 'touchstart') e.preventDefault();
            const state = canvasStates[canvasId];
            if (!state) return;
            
            state.isDrawing = true;
            const rect = state.canvas.getBoundingClientRect();
            state.lastX = (e.clientX || e.touches[0].clientX) - rect.left;
            state.lastY = (e.clientY || e.touches[0].clientY) - rect.top;
        }

        function draw(e, canvasId) {
            const state = canvasStates[canvasId];
            if (!state || !state.isDrawing) return;
            
            const rect = state.canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            state.ctx.strokeStyle = canvasId === 'name-canvas' ? '#ff6b9d' : '#8a2be2';
            state.ctx.lineWidth = 3;
            state.ctx.lineCap = 'round';
            state.ctx.shadowBlur = 10;
            state.ctx.shadowColor = canvasId === 'name-canvas' ? '#ff6b9d' : '#8a2be2';
            state.ctx.beginPath();
            state.ctx.moveTo(state.lastX, state.lastY);
            state.ctx.lineTo(x, y);
            state.ctx.stroke();
            state.lastX = x;
            state.lastY = y;
            
            if (canvasId === 'glitter-canvas') {
                glitterDrawCount++;
            }
        }

        function stopDrawing(canvasId) {
            const state = canvasStates[canvasId];
            if (!state) return;
            state.isDrawing = false;
        }

        function handleTouchStart(e, canvasId) {
            startDrawing(e, canvasId);
        }

        function handleTouchMove(e, canvasId) {
            draw(e, canvasId);
        }

        function clearNameBoard() {
            const state = canvasStates['name-canvas'];
            if (!state) return;
            state.ctx.fillStyle = '#1a1a2e';
            state.ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);
            document.getElementById('name-board-message').textContent = '';
        }

        function saveNameBoard() {
            const message = document.getElementById('name-board-message');
            const state = canvasStates['name-canvas'];
            if (!state) return;
            state.canvas.style.boxShadow = '0 0 30px #ff6b9d';
            message.textContent = 'Perfect! Your name glows with cosmic power!';
            setTimeout(() => {
                state.canvas.style.boxShadow = 'none';
            }, 2000);
        }

        function clearBoard() {
            const state = canvasStates['chalkboard'];
            if (!state) return;
            state.ctx.clearRect(0, 0, state.canvas.width, state.canvas.height);
            state.ctx.fillStyle = '#1a1a2e';
            state.ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);
            document.getElementById('drawing-message').textContent = '';
        }

        function bringToLife() {
            const message = document.getElementById('drawing-message');
            const state = canvasStates['chalkboard'];
            if (!state) return;
            message.textContent = 'Your drawing is COMING ALIVE! Watch the dino wiggle!';
            
            // Create a temporary canvas to hold the drawing
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = state.canvas.width;
            tempCanvas.height = state.canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(state.canvas, 0, 0);
            
            let wiggleCount = 0;
            const wiggleInterval = setInterval(() => {
                // Clear the canvas
                state.ctx.fillStyle = '#1a1a2e';
                state.ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);
                
                // Apply wiggle transformation
                state.ctx.save();
                state.ctx.translate(state.canvas.width / 2, state.canvas.height / 2);
                
                const shake = wiggleCount % 2 === 0 ? 10 : -10;
                const rotate = wiggleCount % 2 === 0 ? 0.15 : -0.15;
                state.ctx.rotate(rotate);
                state.ctx.translate(shake, 0);
                
                state.ctx.translate(-state.canvas.width / 2, -state.canvas.height / 2);
                
                // Draw the saved image with the transformation
                state.ctx.drawImage(tempCanvas, 0, 0);
                state.ctx.restore();
                
                wiggleCount++;
                if (wiggleCount > 20) {
                    clearInterval(wiggleInterval);
                    // Restore original drawing
                    state.ctx.fillStyle = '#1a1a2e';
                    state.ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);
                    state.ctx.drawImage(tempCanvas, 0, 0);
                }
            }, 50);
            
            state.canvas.style.boxShadow = '0 0 40px #8a2be2, 0 0 60px #ff6b9d';
            
            // Rumble sounds!
            initAudio();
            for (let i = 0; i < 20; i++) {
                setTimeout(() => playTone(100 + Math.random() * 150, 0.1, 'square'), i * 50);
            }
            
            setTimeout(() => {
                state.canvas.style.boxShadow = 'none';
                message.textContent = 'ü¶ñ Your dino is ALIVE! Ready for Chapter 2!';
            }, 2000);
        }

        function saveDrawing() {
            const message = document.getElementById('drawing-message');
            message.textContent = 'Your cosmic creation has been saved to the eternal memory banks!';
        }

        function createStars() {
            const container = document.getElementById('stars-container');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(star);
            }
        }

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function selectDinoInstrument(instrument) {
            initAudio();
            currentDinoInstrument = instrument;
            const messages = {
                piano: "üéπ Raaarrr touches the Cosmic Piano and it sparkles!",
                harp: "ü™ï The Star Harp glows as Raaarrr plucks its strings!",
                flute: "ü™à Raaarrr's breath makes the Nebula Flute sing!",
                drums: "ü•Å Raaarrr's tail is READY to POUND those Galaxy Drums!"
            };
            document.getElementById('instrument-message').textContent = messages[instrument];
            playTone(440, 0.5, instrument);
            
            // Add floating musical notes for all instruments!
            const container = document.querySelector('#chapter2 .chalkboard-container');
            if (container) {
                const notes = ['‚ô™', '‚ô´', '‚ô¨', '‚ô©'];
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const note = document.createElement('div');
                        note.textContent = notes[Math.floor(Math.random() * notes.length)];
                        note.style.cssText = `position: absolute; font-size: ${30 + Math.random() * 20}px; color: hsl(${Math.random() * 360}, 100%, 70%); text-shadow: 0 0 15px currentColor; left: ${Math.random() * 80 + 10}%; top: 50%; pointer-events: none; animation: float-up 2s ease-out forwards; z-index: 100;`;
                        container.style.position = 'relative';
                        container.appendChild(note);
                        setTimeout(() => note.remove(), 2000);
                    }, i * 150);
                }
            }
        }

        function playRaaaarrrSound() {
            if (!currentDinoInstrument) {
                document.getElementById('instrument-message').textContent = "‚ö†Ô∏è Choose an instrument first!";
                return;
            }
            
            const raaarrr = document.getElementById('raaarrr-character');
            
            if (currentDinoInstrument === 'drums') {
                // ü•Å MEGA TAIL DRUMMING ANIMATION! ü•Å
                let taps = 0;
                const tapInterval = setInterval(() => {
                    if (taps % 2 === 0) {
                        // Swing LEFT
                        raaarrr.style.transform = 'scale(2.0) rotate(-50deg) translateX(-40px) translateY(-20px)';
                        raaarrr.textContent = 'ü¶ñ';
                    } else {
                        // Swing RIGHT  
                        raaarrr.style.transform = 'scale(2.0) rotate(50deg) translateX(40px) translateY(-20px)';
                        raaarrr.textContent = 'ü¶ï';
                    }
                    
                    // Spawn flying notes and emojis on EVERY tap!
                    const note = document.createElement('div');
                    note.textContent = ['‚ô™', '‚ô´', '‚ô¨', 'ü•Å', 'üí•'][Math.floor(Math.random() * 5)];
                    note.style.cssText = `position: absolute; font-size: ${50 + Math.random() * 20}px; color: ${['#ffff00', '#ff6b9d', '#00ff00'][Math.floor(Math.random() * 3)]}; text-shadow: 0 0 30px currentColor; animation: float-up 1.5s ease-out forwards; left: ${Math.random() * 400 - 200}px; top: 10%; pointer-events: none; z-index: 1000;`;
                    const container = raaarrr.parentElement;
                    container.style.position = 'relative';
                    container.appendChild(note);
                    setTimeout(() => note.remove(), 1500);
                    
                    // DRUM BOOM sound on every tap!
                    initAudio();
                    const drumOsc = audioContext.createOscillator();
                    const drumGain = audioContext.createGain();
                    drumOsc.connect(drumGain);
                    drumGain.connect(audioContext.destination);
                    drumOsc.type = 'square';
                    drumOsc.frequency.setValueAtTime(60, audioContext.currentTime);
                    drumGain.gain.setValueAtTime(0.8, audioContext.currentTime);
                    drumGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    drumOsc.start(audioContext.currentTime);
                    drumOsc.stop(audioContext.currentTime + 0.2);
                    
                    taps++;
                    if (taps > 30) {
                        clearInterval(tapInterval);
                        raaarrr.style.transform = 'scale(1) rotate(0deg) translateX(0) translateY(0)';
                        raaarrr.textContent = 'ü¶ñ';
                    }
                }, 55);
                
                document.getElementById('instrument-message').textContent = "üí•ü•Å RAAARRR! EPIC TAIL DRUMMING! BOOM! BAM! POW! üí•ü•Å";
                
            } else {
                // Regular animation for other instruments
                raaarrr.style.transform = 'scale(1.4) rotate(15deg)';
                setTimeout(() => {
                    raaarrr.style.transform = 'scale(1) rotate(0deg)';
                }, 400);
                document.getElementById('instrument-message').textContent = "RAAARRR! üéµ Beautiful music!";
                
                initAudio();
                playTone(200 + Math.random() * 200, 0.4, currentDinoInstrument);
            }
        }

        function playTone(frequency, duration, instrument) {
            initAudio();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            let gainValue = 0.3;
            switch(instrument) {
                case 'piano': 
                    oscillator.type = 'triangle';
                    gainValue = 0.35;
                    break;
                case 'harp': 
                    oscillator.type = 'sine';
                    gainValue = 0.5;
                    // Add a second harmonic for harp
                    const harpOsc2 = audioContext.createOscillator();
                    const harpGain2 = audioContext.createGain();
                    harpOsc2.connect(harpGain2);
                    harpGain2.connect(audioContext.destination);
                    harpOsc2.type = 'sine';
                    harpOsc2.frequency.setValueAtTime(frequency * 2, audioContext.currentTime);
                    harpGain2.gain.setValueAtTime(0, audioContext.currentTime);
                    harpGain2.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.01);
                    harpGain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                    harpOsc2.start(audioContext.currentTime);
                    harpOsc2.stop(audioContext.currentTime + duration);
                    break;
                case 'flute': 
                    oscillator.type = 'sine';
                    gainValue = 0.4;
                    // Higher frequency for flute sound
                    frequency = frequency * 1.5;
                    break;
                case 'drums': 
                    oscillator.type = 'square';
                    gainValue = 0.6;
                    frequency = 80; // Low bass drum sound
                    break;
                default: 
                    oscillator.type = 'sine';
                    gainValue = 0.3;
            }
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(gainValue, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        let currentHealingInstrument = 'harp';

        function selectHealingInstrument(instrument) {
            currentHealingInstrument = instrument;
            const messages = {
                harp: "ü™ï Star Harp selected for harmony!",
                flute: "ü™à Nebula Flute selected for harmony!",
                piano: "üéπ Cosmic Piano selected for harmony!"
            };
            document.getElementById('quest-message').textContent = messages[instrument];
            initAudio();
            playTone(440, 0.3, instrument);
        }

        function initGlitterParticles() {
            if (particlesActive) return;
            particlesActive = true;
            particlesReturning = false;
            const pCanvas = document.getElementById('particles');
            if (!pCanvas) return;
            const pCtx = pCanvas.getContext('2d');
            particles = [];
            
            // TRUE CENTER of canvas
            const centerX = pCanvas.width / 2;  // 300
            const centerY = pCanvas.height / 2; // 200
            
            console.log('‚≠ê Galaxy POINT starts at center:', centerX, centerY);
            
            // ALL particles start as TIGHT CLUSTER at center (appearing as one point!)
            for (let i = 0; i < 50; i++) {
                const angle = (Math.PI * 2 * i) / 50;
                const tinyRadius = Math.random() * 3; // Tiny cluster, looks like a point
                
                particles.push({
                    x: centerX + Math.cos(angle) * tinyRadius,
                    y: centerY + Math.sin(angle) * tinyRadius,
                    vx: Math.cos(angle) * 0.5, // Very slow drift
                    vy: Math.sin(angle) * 0.5,
                    angle: angle,
                    exploded: false,
                    color: `hsl(${Math.random() * 360}, 100%, 70%)`,
                    size: Math.random() * 5 + 3
                });
            }
            
            function animateParticles() {
                if (!particlesActive) return;
                pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
                
                particles.forEach(p => {
                    if (particlesReturning) {
                        // When "Compose Harmony" clicked ‚Üí EXPLODE and SWIRL!
                        if (!p.exploded) {
                            // RELEASE! Give them explosion velocity
                            p.vx = Math.cos(p.angle) * (4 + Math.random() * 6);
                            p.vy = Math.sin(p.angle) * (4 + Math.random() * 6);
                            p.exploded = true;
                        }
                        // Add swirling motion as they spread
                        const spiralForce = 0.05;
                        p.vx += -p.y * spiralForce / 100;
                        p.vy += p.x * spiralForce / 100;
                    }
                    
                    p.x += p.vx;
                    p.y += p.vy;
                    
                    // Keep particles in bounds
                    if (p.x < 5) { p.x = 5; p.vx = Math.abs(p.vx) * 0.8; }
                    if (p.x > pCanvas.width - 5) { p.x = pCanvas.width - 5; p.vx = -Math.abs(p.vx) * 0.8; }
                    if (p.y < 5) { p.y = 5; p.vy = Math.abs(p.vy) * 0.8; }
                    if (p.y > pCanvas.height - 5) { p.y = pCanvas.height - 5; p.vy = -Math.abs(p.vy) * 0.8; }
                    
                    // Draw glowing particle
                    pCtx.fillStyle = p.color;
                    pCtx.shadowBlur = 15;
                    pCtx.shadowColor = p.color;
                    pCtx.beginPath();
                    pCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    pCtx.fill();
                });
                
                requestAnimationFrame(animateParticles);
            }
            animateParticles();
        }

        function healWithDraw() {
            const message = document.getElementById('quest-message');
            const state = canvasStates['glitter-canvas'];
            
            if (glitterDrawCount < 5) {
                message.textContent = '‚úèÔ∏è Keep drawing! Your healing magic needs more strokes to work!';
                return;
            }
            
            message.textContent = '‚ú® Your drawing HEALS the glitches! Glitter sparkles RESTORED!';
            
            if (state) {
                const imageData = state.ctx.getImageData(0, 0, state.canvas.width, state.canvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    if (b > 180 || (r > 200 && g < 150)) {
                        data[i] = Math.min(255, r + 100);
                        data[i + 1] = Math.min(255, g + 150);
                        data[i + 2] = Math.min(255, b + 50);
                    }
                }
                
                state.ctx.putImageData(imageData, 0, 0);
                state.canvas.style.boxShadow = '0 0 60px #ff6b9d, 0 0 80px #00ff00';
                
                initAudio();
                playTone(659, 0.4, 'harp');
                setTimeout(() => playTone(784, 0.4, 'harp'), 150);
                setTimeout(() => playTone(880, 0.4, 'harp'), 300);
                setTimeout(() => playTone(1046, 0.5, 'harp'), 450);
                
                setTimeout(() => state.canvas.style.boxShadow = 'none', 2000);
            }
            
            glitterDrawCount = 0;
        }

        function clearGlitterCanvas() {
            const state = canvasStates['glitter-canvas'];
            if (!state) return;
            const gradient = state.ctx.createLinearGradient(0, 0, 0, state.canvas.height);
            gradient.addColorStop(0, '#ff6b9d');
            gradient.addColorStop(1, '#8a2be2');
            state.ctx.fillStyle = gradient;
            state.ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);
            document.getElementById('quest-message').textContent = 'Canvas cleared - draw your healing magic!';
            glitterDrawCount = 0;
        }

        function harmonizeWithMusic() {
            initAudio();
            
            // Bring ALL particles back to center!
            particlesReturning = true;
            
            const message = document.getElementById('quest-message');
            message.textContent = 'üåÄ‚ú® HARMONY ACTIVATED! Particles returning to center!';
            message.style.animation = 'pulse 0.5s ease-in-out 5';
            
            // Keep particles returning for longer
            setTimeout(() => {
                particlesReturning = false;
                message.textContent = '‚ú®üåü Harmony restored! Glitches healed! The galaxy sparkles!';
                message.style.animation = 'none';
            }, 4000);
            
            // Play beautiful harmony with the selected instrument
            let freqs = [523, 659, 784, 880, 1046];
            
            freqs.forEach((f, i) => {
                setTimeout(() => {
                    playTone(f, 1.2, currentHealingInstrument);
                    const state = canvasStates['glitter-canvas'];
                    if (state) {
                        const colors = ['#ff6b9d', '#8a2be2', '#00ff00', '#ffff00', '#00ffff'];
                        state.canvas.style.boxShadow = `0 0 60px ${colors[i]}`;
                    }
                }, i * 400);
            });
            
            setTimeout(() => {
                const state = canvasStates['glitter-canvas'];
                if (state) state.canvas.style.boxShadow = 'none';
            }, 3000);
        }

        function placeBlock(type) {
            const message = document.getElementById('build-message');
            const blocks = { wheel: 'üöó', antenna: 'üì°', button: 'üîò' };
            const state = canvasStates['build-canvas'];
            
            // Limit control buttons to 3 max
            if (type === 'button' && buttonCount >= 3) {
                message.textContent = '‚ö†Ô∏è Maximum 3 control buttons! Use the ones you have!';
                initAudio();
                playTone(300, 0.3, 'square');
                return;
            }
            
            if (state) {
                const x = Math.random() * (state.canvas.width - 80) + 40;
                const y = Math.random() * (state.canvas.height - 80) + 40;
                
                const ctx = state.ctx;
                ctx.save();
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.shadowColor = '#000000';
                ctx.shadowBlur = 5;
                ctx.fillText(blocks[type], x, y);
                ctx.restore();
                
                if (type === 'wheel') {
                    buggyPositions.push({x: x, y: y, direction: 'right'});
                }
                
                if (type === 'button') {
                    buttonCount++;
                    
                    // Add glowing lightning bolt
                    ctx.save();
                    ctx.font = '40px Arial';
                    ctx.fillStyle = '#ffff00';
                    ctx.shadowColor = '#ffff00';
                    ctx.shadowBlur = 30;
                    ctx.fillText('‚ö°', x, y - 25);
                    ctx.restore();
                    
                    // FLASH the canvas!
                    let flashCount = 0;
                    const flashInterval = setInterval(() => {
                        if (flashCount % 2 === 0) {
                            state.canvas.style.boxShadow = '0 0 50px #ffff00';
                        } else {
                            state.canvas.style.boxShadow = 'none';
                        }
                        flashCount++;
                        if (flashCount > 6) {
                            clearInterval(flashInterval);
                            state.canvas.style.boxShadow = 'none';
                        }
                    }, 150);
                    
                    // Play electrical sound
                    initAudio();
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => playTone(800 + Math.random() * 400, 0.1, 'square'), i * 100);
                    }
                    
                    message.textContent = `üîò‚ö° CONTROL BUTTON ${buttonCount}/3 ACTIVATED! Power surging!`;
                } else {
                    message.textContent = `Placed ${blocks[type]}! ${type === 'wheel' ? 'Buggy ready to roll!' : 'Keep building!'}`;
                }
                
                initAudio();
                playTone(523, 0.2, 'piano');
            }
        }

        function setBuggyDirection(dir) {
            buggyDirection = dir;
            const arrows = {up: '‚¨ÜÔ∏è', down: '‚¨áÔ∏è', left: '‚û°Ô∏è', right: '‚¨ÖÔ∏è'};
            const names = {up: 'Up', down: 'Down', left: 'Back (Right)', right: 'Forward (Left)'};
            document.getElementById('direction-message').textContent = `Current: ${arrows[dir]} ${names[dir]}`;
            
            initAudio();
            playTone(440, 0.2, 'piano');
        }

        function toggleLight() {
            lightOn = !lightOn;
            const status = document.getElementById('light-status');
            const message = document.getElementById('build-message');
            initAudio();
            
            if (lightOn) {
                status.innerHTML = 'üü¢ GO - Buggies Rolling!';
                status.className = 'light-status light-green';
                
                if (buggyPositions.length > 0) {
                    buggiesMoving = true;
                    animateBuggies();
                    message.textContent = 'üöó GREEN LIGHT! Buggies are ROLLING!';
                } else {
                    message.textContent = 'üü¢ Green light active! Add buggies (üöó) to see them roll!';
                }
                
                playTone(440, 0.3, 'sine');
                setTimeout(() => playTone(523, 0.3, 'sine'), 150);
                setTimeout(() => playTone(659, 0.5, 'sine'), 300);
                
                const raaaarrrAudio = document.getElementById('raaarrr-audio');
                if (raaaarrrAudio) {
                    raaaarrrAudio.currentTime = 0;
                    raaaarrrAudio.play().catch(e => console.log('Raaarrr audio:', e));
                }
                
            } else {
                status.innerHTML = 'üî¥ STOP - Safety Check!';
                status.className = 'light-status light-red';
                
                buggiesMoving = false;
                if (buggyAnimationFrame) {
                    cancelAnimationFrame(buggyAnimationFrame);
                }
                
                playTone(392, 0.5, 'square');
                playTone(349, 0.5, 'square');
                message.textContent = '‚õî RED LIGHT! All buggies STOPPED!';
                
                const ariaAudio = document.getElementById('aria-pause-audio');
                if (ariaAudio) {
                    ariaAudio.currentTime = 0;
                    ariaAudio.play().catch(e => console.log('ARIA audio:', e));
                }
            }
        }

        function animateBuggies() {
            const state = canvasStates['build-canvas'];
            if (!state || !buggiesMoving) return;
            
            if (!puttInterval) {
                puttInterval = setInterval(() => {
                    if (buggiesMoving) {
                        initAudio();
                        playTone(150 + Math.random() * 50, 0.15, 'square');
                    }
                }, 400);
            }
            
            function animate() {
                if (!buggiesMoving) {
                    if (puttInterval) {
                        clearInterval(puttInterval);
                        puttInterval = null;
                    }
                    return;
                }
                
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = state.canvas.width;
                tempCanvas.height = state.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(state.canvas, 0, 0);
                
                state.ctx.fillStyle = '#1a1a2e';
                state.ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);
                state.ctx.drawImage(tempCanvas, 0, 0);
                
                buggyPositions.forEach(buggy => {
                    const speed = 4;
                    
                    state.ctx.save();
                    state.ctx.translate(buggy.x, buggy.y);
                    
                    // üöó emoji faces LEFT naturally
                    // Use SCALE to flip horizontally for forward/right
                    // User wants: Forward (‚û°Ô∏è) = goes LEFT, Back (‚¨ÖÔ∏è) = goes RIGHT
                    switch(buggyDirection) {
                        case 'right': // FORWARD button ‚Üí buggy goes LEFT
                            buggy.x -= speed;
                            if (buggy.x < -30) buggy.x = state.canvas.width + 30;
                            // No flip - faces left naturally
                            break;
                        case 'left': // BACK button ‚Üí buggy goes RIGHT
                            buggy.x += speed;
                            if (buggy.x > state.canvas.width + 30) buggy.x = -30;
                            state.ctx.scale(-1, 1); // Flip to face right
                            break;
                        case 'up': // UP ‚Üë
                            buggy.y -= speed;
                            if (buggy.y < -30) buggy.y = state.canvas.height + 30;
                            state.ctx.rotate(Math.PI / 2);
                            break;
                        case 'down': // DOWN ‚Üì
                            buggy.y += speed;
                            if (buggy.y > state.canvas.height + 30) buggy.y = -30;
                            state.ctx.rotate(-Math.PI / 2);
                            break;
                    }
                    
                    state.ctx.font = '48px Arial';
                    state.ctx.textAlign = 'center';
                    state.ctx.textBaseline = 'middle';
                    state.ctx.shadowColor = '#00ff00';
                    state.ctx.shadowBlur = 10;
                    state.ctx.fillText('üöó', 0, 0);
                    state.ctx.restore();
                });
                
                buggyAnimationFrame = requestAnimationFrame(animate);
            }
            
            animate();
        }

        function bringBuildToLife() {
            const message = document.getElementById('build-message');
            const state = canvasStates['build-canvas'];
            
            if (buggyPositions.length === 0) {
                message.textContent = '‚ö†Ô∏è Add some buggies (üöó) first, then toggle GO to see them roll!';
                return;
            }
            
            message.textContent = 'üåü Your moon base ACTIVATES! Hit TOGGLE for GO to start buggies rolling!';
            
            if (state) {
                const colors = ['#00ff00', '#00ffff', '#ffff00', '#ff6b9d'];
                let colorIndex = 0;
                const glowInterval = setInterval(() => {
                    state.canvas.style.boxShadow = `0 0 50px ${colors[colorIndex]}`;
                    colorIndex++;
                    if (colorIndex >= colors.length) {
                        clearInterval(glowInterval);
                        state.canvas.style.boxShadow = 'none';
                    }
                }, 300);
                
                initAudio();
                playTone(440, 0.3, 'sine');
                setTimeout(() => playTone(523, 0.3, 'sine'), 150);
                setTimeout(() => playTone(659, 0.3, 'sine'), 300);
                setTimeout(() => playTone(784, 0.5, 'sine'), 450);
                
                setTimeout(() => initLaunchParticles(), 500);
            }
        }

        function clearBuildCanvas() {
            const state = canvasStates['build-canvas'];
            if (!state) return;
            
            buggiesMoving = false;
            if (buggyAnimationFrame) {
                cancelAnimationFrame(buggyAnimationFrame);
            }
            if (puttInterval) {
                clearInterval(puttInterval);
                puttInterval = null;
            }
            
            state.ctx.fillStyle = '#1a1a2e';
            state.ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);
            buggyPositions = [];
            buttonCount = 0; // Reset button count
            
            lightOn = true;
            const status = document.getElementById('light-status');
            status.innerHTML = 'üü¢ GO - Ready for Launch!';
            status.className = 'light-status light-green';
            
            buggyDirection = 'right';
            document.getElementById('direction-message').textContent = 'Current: ‚¨ÖÔ∏è Forward (Left)';
            
            document.getElementById('build-message').textContent = 'Canvas cleared - start building again!';
        }

        function initLaunchParticles() {
            const pCanvas = document.getElementById('launch-particles');
            if (!pCanvas) return;
            
            const pCtx = pCanvas.getContext('2d');
            pCtx.clearRect(0, 0, 600, 400);
            
            launchParticles = [];
            launchAnimating = true;
            
            for (let i = 0; i < 80; i++) {
                launchParticles.push({
                    x: 300,
                    y: 200,
                    vx: (Math.random() - 0.5) * 20,
                    vy: (Math.random() - 0.5) * 20 - 10,
                    color: ['#00ff00', '#ffff00', '#00ffff', '#ff6b9d'][Math.floor(Math.random() * 4)],
                    size: Math.random() * 6 + 3,
                    life: 150
                });
            }
            
            function animateLaunch() {
                if (!launchAnimating) return;
                
                pCtx.clearRect(0, 0, 600, 400);
                
                launchParticles = launchParticles.filter(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.5;
                    p.life -= 1;
                    
                    pCtx.fillStyle = p.color;
                    pCtx.globalAlpha = p.life / 150;
                    pCtx.beginPath();
                    pCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    pCtx.fill();
                    
                    return p.life > 0;
                });
                
                pCtx.globalAlpha = 1;
                
                if (launchParticles.length > 0) {
                    requestAnimationFrame(animateLaunch);
                } else {
                    launchAnimating = false;
                }
            }
            
            animateLaunch();
            
            initAudio();
            playTone(659, 0.5, 'sine');
            setTimeout(() => playTone(784, 0.5, 'sine'), 200);
            setTimeout(() => playTone(880, 0.3, 'sine'), 400);
        }

        function shareBuild() {
            const state = canvasStates['build-canvas'];
            if (!state) return;
            const canvasData = state.canvas.toDataURL();
            const shareText = 'Check my moon base from Little X Book 2! ü¶ñüöÄ';
            if (navigator.share) {
                navigator.share({ title: 'My Dino Build', text: shareText, url: window.location.href });
            } else {
                alert(shareText + '\nCopy URL to share!');
            }
        }

        function enableAllAudio() {
            initAudio();
            ['raaarrr-audio', 'aria-teamwork-audio', 'aria-pause-audio', 
             'raaarrr-intro-audio', 'aria-intro-audio', 'raaarrr-oops-audio'].forEach(id => {
                const audio = document.getElementById(id);
                if (audio) {
                    audio.play().then(() => audio.pause()).catch(e => console.log('Audio unlock:', e));
                }
            });
            
            playTone(523, 0.3, 'piano');
            setTimeout(() => playTone(659, 0.3, 'piano'), 150);
            setTimeout(() => playTone(784, 0.5, 'piano'), 300);
            
            alert('üéµ SOUNDS ENABLED! You just heard 3 beeps - audio is working! üéµ');
            console.log('All audio unlocked');
        }

        function saveProgress(chapter) {
            localStorage.setItem('littleXProgress', chapter);
        }

        function loadProgress() {
            const saved = localStorage.getItem('littleXProgress');
            if (saved) loadChapter(parseInt(saved));
        }

        function loadChapter(chapterNum) {
            try {
                // STOP ALL AUDIO when loading
                const allAudio = ['raaarrr-audio', 'aria-teamwork-audio', 'aria-pause-audio', 
                                 'raaarrr-intro-audio', 'aria-intro-audio', 'raaarrr-oops-audio'];
                allAudio.forEach(id => {
                    const audio = document.getElementById(id);
                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                });
                
                particlesActive = false;
                launchAnimating = false;
                
                const particlesCanvas = document.getElementById('particles');
                if (particlesCanvas) {
                    const ctx = particlesCanvas.getContext('2d');
                    ctx.clearRect(0, 0, 600, 400);
                }
                const launchCanvas = document.getElementById('launch-particles');
                if (launchCanvas) {
                    const ctx = launchCanvas.getContext('2d');
                    ctx.clearRect(0, 0, 600, 400);
                }
                
                document.querySelectorAll('.chapter').forEach(ch => ch.style.display = 'none');
                const targetChapter = document.getElementById('chapter' + chapterNum);
                if (targetChapter) {
                    targetChapter.style.display = 'block';
                    window.scrollTo(0, 0);
                }
                
                // Wait longer before playing audio to avoid conflict
                if (chapterNum === 2) {
                    setTimeout(() => {
                        initAudio();
                        const raaaarrrIntro = document.getElementById('raaarrr-intro-audio');
                        if (raaaarrrIntro) {
                            raaaarrrIntro.volume = 0.7;
                            raaaarrrIntro.play().catch(e => console.log('Raaarrr intro:', e.message));
                        }
                    }, 1000);
                } else if (chapterNum === 3) {
                    setTimeout(initGlitterParticles, 100);
                    setupDrawing('glitter-canvas');
                } else if (chapterNum === 4) {
                    setupDrawing('build-canvas');
                    
                    buggyPositions = [];
                    buggiesMoving = false;
                    buggyDirection = 'right';
                    if (buggyAnimationFrame) {
                        cancelAnimationFrame(buggyAnimationFrame);
                    }
                    if (puttInterval) {
                        clearInterval(puttInterval);
                        puttInterval = null;
                    }
                    lightOn = true;
                    
                    setTimeout(() => {
                        initAudio();
                        const ariaIntro = document.getElementById('aria-intro-audio');
                        if (ariaIntro) {
                            ariaIntro.volume = 0.7;
                            ariaIntro.play().catch(e => console.log('ARIA intro:', e.message));
                        }
                    }, 1200);
                } else if (chapterNum === 1) {
                    setupDrawing('name-canvas');
                    setupDrawing('chalkboard');
                }
            } catch (e) {
                console.error('Load chapter error:', e);
            }
        }

        function nextChapter() {
            saveProgress(1);
            loadChapter(2);
        }

        function vortexToChapter3() {
            // Play oops audio first, THEN load chapter after it has time to start
            initAudio();
            const oopsAudio = document.getElementById('raaarrr-oops-audio');
            if (oopsAudio) {
                oopsAudio.volume = 0.7;
                oopsAudio.play().catch(e => console.log('Oops audio:', e.message));
            }
            // Wait longer so audio doesn't get interrupted
            setTimeout(() => loadChapter(3), 2000);
        }

        window.addEventListener('DOMContentLoaded', function() {
            createStars();
            setupDrawing('name-canvas');
            setupDrawing('chalkboard');

            setTimeout(() => {
                const canvas = document.getElementById('chalkboard');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.strokeStyle = '#8a2be2';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
                    ctx.setLineDash([]);
                }
            }, 100);
            
            loadProgress();
            console.log('Little X Book 2 - Complete & Ready! üñçÔ∏èü¶ñ‚ú®');
        });
    </script>
    <!-- Audio Narration System -->
    <script src="https://coldnsteel.github.io/GMSRFC/little-x-audio-narration.js"></script>
</body>
</html>
